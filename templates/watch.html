{% extends "base.html" %}
{% block content %}
  <div class="grid gap-6 lg:grid-cols-12">
    <!-- LEFT -->
    <div class="lg:col-span-8">
      <div class="overflow-hidden rounded-2xl border border-white/10 bg-black">
        <div class="relative aspect-video w-full" data-mytube-player>
          {% if video['embed_html'] %}
            <div class="absolute inset-0 reddit-embed">
              {{ video['embed_html'] | safe }}
            </div>
          {% else %}
            <iframe
              class="absolute inset-0 h-full w-full"
              src="{{ video['embed_url'] }}"
              title="{{ video['title'] }}"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen>
            </iframe>
          {% endif %}
        </div>
      </div>

      <div class="mt-4">
        <h1 class="text-lg font-semibold leading-snug">{{ video['title'] }}</h1>

        <div class="mt-2 flex flex-wrap items-center gap-2 text-xs text-zinc-400">
          <span class="rounded-full border border-white/10 bg-white/5 px-2 py-1 uppercase">{{ video['provider']|upper }}</span>
          {% if video['category'] %}
            <span class="rounded-full border border-white/10 bg-white/5 px-2 py-1">{{ video['category'] }}</span>
          {% endif %}
          <span><span id="viewsCount">{{ video['views'] }}</span> {{ t('views') }}</span>
          <span class="opacity-50">Â·</span>
          <span><span id="likesCount">{{ video['likes'] }}</span> {{ t('likes') }}</span>
        </div>

        {% if video['description'] %}
          <div class="mt-3 whitespace-pre-wrap rounded-2xl border border-white/10 bg-white/5 p-4 text-sm text-zinc-200">
            {{ video['description'] }}
          </div>
        {% endif %}

        <div class="mt-4 flex flex-wrap items-center gap-2">
          <form id="likeForm" method="post" action="{{ url_for('like', video_id=video['id']) }}">
            <button id="likeBtn" type="submit"
              class="rounded-full border px-4 py-2 text-sm transition
                     {% if liked %}
                       border-white/20 bg-white/15 hover:bg-white/20
                     {% else %}
                       border-white/10 bg-white/5 hover:bg-white/10
                     {% endif %}">
              <span id="likeLabel">{% if liked %}{{ t('liked_btn') }}{% else %}{{ t('like_btn') }}{% endif %}</span>
            </button>
          </form>

          <a href="{{ video['source_url'] }}" target="_blank" rel="noopener"
             class="rounded-full border border-white/10 bg-white/5 px-4 py-2 text-sm hover:bg-white/10">
            {{ t('open_original') }}
          </a>

          <button type="button"
            class="rounded-full border border-white/10 bg-white/5 px-4 py-2 text-sm hover:bg-white/10"
            onclick="(function(){const el=document.querySelector('[data-mytube-player]'); if(!el) return; const f=el.requestFullscreen||el.webkitRequestFullscreen||el.mozRequestFullScreen||el.msRequestFullscreen; if(f) f.call(el);})()">
            â›¶ Fullscreen
          </button>
        </div>

        <!-- Comments -->
        <div class="mt-6">
          <h2 class="text-base font-semibold">{{ t('comments_title') }}</h2>

          <form class="mt-3 space-y-2 rounded-2xl border border-white/10 bg-white/5 p-4"
                method="post" action="{{ url_for('comment', video_id=video['id']) }}">
            <div class="grid gap-2 sm:grid-cols-2">
              <div>
                <label class="text-xs text-zinc-300">{{ t('name_optional') }}</label>
                <input name="author"
                  placeholder="{{ t('name_placeholder') }}"
                  class="mt-1 w-full rounded-xl border border-white/10 bg-zinc-900/60 px-3 py-2 text-sm outline-none placeholder:text-zinc-500 focus:border-white/20">
              </div>
              <div class="hidden sm:block"></div>
            </div>

            <div>
              <label class="text-xs text-zinc-300">{{ t('comment_label') }}</label>
              <textarea name="body" rows="3" required
                placeholder="{{ t('comment_placeholder') }}"
                class="mt-1 w-full rounded-xl border border-white/10 bg-zinc-900/60 px-3 py-2 text-sm outline-none placeholder:text-zinc-500 focus:border-white/20"></textarea>
            </div>

            <div class="flex justify-end">
              <button type="submit"
                class="rounded-full border border-white/10 bg-white/10 px-4 py-2 text-sm font-medium hover:bg-white/15">
                {{ t('post_btn') }}
              </button>
            </div>
          </form>

          <div class="mt-4 space-y-3">
            {% for c in comments %}
              <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                <div class="flex items-center justify-between gap-3">
                  <b class="text-sm">{{ c['author'] }}</b>
                  <span class="text-xs text-zinc-500">{{ c['created_at'] }}</span>
                </div>
                <div class="mt-2 text-sm text-zinc-200 whitespace-pre-wrap">{{ c['body'] }}</div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="lg:col-span-4">
      <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
        {% if playlist %}
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-sm font-semibold">{{ t('playlist_sidebar') }}: {{ playlist['playlist_name'] }}</div>
              {% if next_in_playlist_id %}
                <div id="autoNextText" class="mt-1 text-xs text-zinc-400 hidden"></div>
              {% endif %}
            </div>

            {% if next_in_playlist_id %}
              <div class="flex flex-col items-end gap-2">
                <a id="nextBtn"
                   href="{{ url_for('watch', video_id=next_in_playlist_id) }}"
                   class="rounded-full border border-white/10 bg-white/10 px-4 py-2 text-sm hover:bg-white/15">
                  {{ t('next_in_playlist') }}
                </a>

                <label class="flex items-center gap-2 text-xs text-zinc-300 select-none">
                  <input id="autoNextToggle" type="checkbox"
                         class="h-4 w-4 rounded border-white/20 bg-zinc-900">
                  {{ t('autonext') }}
                </label>
              </div>
            {% endif %}
          </div>

          {% if playlist_items and playlist_items|length > 0 %}
            <div class="mt-3 space-y-2">
              {% for r in playlist_items %}
                <a href="{{ url_for('watch', video_id=r['id']) }}"
                   class="flex gap-3 rounded-xl p-2 hover:bg-white/5 {% if r['id']==video['id'] %}bg-white/7{% endif %}">
                  <div class="aspect-video w-36 shrink-0 overflow-hidden rounded-xl bg-zinc-900">
                    {% if r['thumbnail_url'] %}
                      <img src="{{ r['thumbnail_url'] }}" alt="" class="h-full w-full object-cover">
                    {% else %}
                      <div class="flex h-full w-full items-center justify-center text-xl opacity-70">ðŸŽ¬</div>
                    {% endif %}
                  </div>
                  <div class="min-w-0">
                    <div class="line-clamp-2 text-sm font-semibold">{{ r['title'] }}</div>
                    <div class="mt-1 text-xs text-zinc-400">
                      #{{ r['position'] }} Â· <span class="uppercase">{{ r['provider'] }}</span>
                    </div>
                  </div>
                </a>
              {% endfor %}
            </div>
          {% else %}
            <div class="mt-3 text-xs text-zinc-400">{{ t('playlist_empty_sidebar') }}</div>
          {% endif %}

        {% else %}
          <div class="text-sm font-semibold">{{ t('up_next') }}</div>

          {% if recommended and recommended|length > 0 %}
            <div class="mt-3 space-y-3">
              {% for r in recommended %}
                <a href="{{ url_for('watch', video_id=r['id']) }}"
                   class="flex gap-3 rounded-xl hover:bg-white/5 p-2">
                  <div class="aspect-video w-40 shrink-0 overflow-hidden rounded-xl bg-zinc-900">
                    {% if r['thumbnail_url'] %}
                      <img src="{{ r['thumbnail_url'] }}" alt="" class="h-full w-full object-cover">
                    {% else %}
                      <div class="flex h-full w-full items-center justify-center text-xl opacity-70">ðŸŽ¬</div>
                    {% endif %}
                  </div>
                  <div class="min-w-0">
                    <div class="line-clamp-2 text-sm font-semibold">{{ r['title'] }}</div>
                    <div class="mt-1 text-xs text-zinc-400">
                      <span class="uppercase">{{ r['provider'] }}</span>
                      <span class="mx-1">Â·</span>
                      <span>{{ r['views'] }} {{ t('views') }}</span>
                    </div>
                  </div>
                </a>
              {% endfor %}
            </div>
          {% else %}
            <div class="mt-3 text-xs text-zinc-400">{{ t('recommended_empty') }}</div>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    // Like (AJAX + highlight)
    (function () {
      const form = document.getElementById('likeForm');
      const btn = document.getElementById('likeBtn');
      const likesEl = document.getElementById('likesCount');
      const label = document.getElementById('likeLabel');
      if (!form || !btn || !likesEl || !label) return;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        btn.disabled = true;

        try {
          const resp = await fetch(form.action + "?ajax=1", {
            method: "POST",
            headers: { "X-Requested-With": "XMLHttpRequest", "Accept": "application/json" }
          });

          if (resp.status === 401) {
            window.location.href = "{{ url_for('login', next=url_for('watch', video_id=video['id'])) }}";
            return;
          }
          if (!resp.ok) throw new Error("bad response");
          const data = await resp.json();
          if (!data || !data.ok) throw new Error("not ok");

          likesEl.textContent = String(data.likes);

          btn.classList.remove("border-white/10","bg-white/5","hover:bg-white/10");
          btn.classList.add("border-white/20","bg-white/15","hover:bg-white/20");
          label.textContent = "{{ t('liked_btn') }}";
        } catch (err) {
          window.location.href = "{{ url_for('watch', video_id=video['id'], noview=1) }}";
        } finally {
          btn.disabled = false;
        }
      });
    })();

    // Auto-next in playlist (10s) + toggle saved in localStorage
    (function () {
      const nextBtn = document.getElementById("nextBtn");
      const toggle = document.getElementById("autoNextToggle");
      const text = document.getElementById("autoNextText");
      if (!nextBtn || !toggle || !text) return;

      const KEY = "mytube_autonext";
      const DEFAULT_ON = true;

      const saved = localStorage.getItem(KEY);
      toggle.checked = (saved === null) ? DEFAULT_ON : (saved === "1");

      toggle.addEventListener("change", () => {
        localStorage.setItem(KEY, toggle.checked ? "1" : "0");
        if (!toggle.checked) text.classList.add("hidden");
      });

      let sec = 10;
      let timer = null;

      function tick() {
        if (!toggle.checked) return;
        text.classList.remove("hidden");
        text.textContent = "{{ t('autonext_in', sec=10) }}".replace("10", String(sec));
        if (sec <= 0) {
          window.location.href = nextBtn.href;
          return;
        }
        sec -= 1;
      }

      // start countdown immediately (clean + simple)
      if (toggle.checked) {
        tick();
        timer = setInterval(tick, 1000);
      }

      // if user toggles ON later, start countdown
      toggle.addEventListener("change", () => {
        if (toggle.checked) {
          sec = 10;
          tick();
          if (timer) clearInterval(timer);
          timer = setInterval(tick, 1000);
        } else {
          if (timer) clearInterval(timer);
          timer = null;
        }
      });
    })();
  </script>
{% endblock %}
